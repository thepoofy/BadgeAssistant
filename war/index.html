<!doctype html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">

    <link type="text/css" rel="stylesheet" href="index.css">

<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js'></script>
<script type="text/javascript" src="jquery.cookie.js" ></script>    
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false" ></script>
<script src="http://platform.twitter.com/anywhere.js?id=Zh0f0QIxQWYQeJFAnYfNQ&amp;v=1"></script>


<script type="text/javascript">


var map;	//the object representing the google map

var markers = [];	//a list of markers to be rendered on the map
var infoWindow;		//only one info window should be displayed at a time

var authToken;
var user;
var userBadges;

	$(document).ready(function()
	{
		if(isAuthenticated())
		{
			//alert("user is authenticated.");
			initializePage();
		}
		else
		{
			if(location.hash && location.hash.indexOf('access_token') != -1)
			{
				var tokenIndex = location.hash.indexOf('access_token');
		
				var token = location.hash.substring(tokenIndex+('access_token='.length));
				
				//save token to cookie
				$.cookie('accessToken', token);
				authToken = token;
				initializePage();
			}
			else
			{
				$("#userInfo")
				.empty()
				.append($(document.createElement('a'))
					.attr('href','javascript:void();')
					.text('Sign into Foursquare')
					.click(function(){
						foursquareLogin();
					})
				);
			}
		
		}
		
		
		initializeMap();
	});
	

function isAuthenticated()
{
	var token = $.cookie('accessToken');
	//alert('token: '+token);
	if(token != null && token.length > 0)
	{
		authToken = token;
		return true;
	}
	
	return false;
}
	
function foursquareLogin()
{
	document.location='https://foursquare.com/oauth2/authenticate?'+
			'client_id=MEGIO23IGONXSI22GLYH2MES1WCDDM5LR5L14K0KVU1XQAFD'+
			'&response_type=token'+
			'&redirect_uri=http://localhost:8888/index.html';
}

function initializePage()
{
	//set the logout and loading message
	showLoginLoadingMessage();
	
	//begin loading the user object
	loadUser();
	
	//begin loading badges
	loadBadges();
}

function showLoginLoadingMessage()
{
	$("#userInfo")
	.empty()
	.append($(document.createElement('a'))
		.attr('href','javascript:void();')
		.text('Sign Out')
	)
	.append($(document.createElement('span'))
		.text('Loading your account...'));
}
function showUserLoaded(userObject)
{
	$("#userInfo")
	.empty()
	.append($(document.createElement('a'))
		.attr('href','javascript:void();')
		.text('Sign Out')
	)
	.append($(document.createElement('div'))
			.append($(document.createElement('img'))
				.attr('src',userObject.photo)))
	.append($(document.createElement('span'))
		.text(userObject.firstName+" "+userObject.lastName));
}

function loadUser()
{
	$.ajax({
		url: "https://api.foursquare.com/v2/users/542718",
		data: {
			client_id: 'MEGIO23IGONXSI22GLYH2MES1WCDDM5LR5L14K0KVU1XQAFD',
			oauth_token: $.cookie('accessToken')
		},
		type: 'GET',
		dataType: 'json',
		success: function(data){
			//updates the loading message to name and picture
			showUserLoaded(data.response.user);
			//sets the globally saved user object
			user = data.response.user;
		}
	});	
		
}
function loadBadges(user)
{
	var userParam = "542718"
	if(user != null)
	{
		userParam = user;
	}	
	$.ajax({
		url: "https://api.foursquare.com/v2/users/"+userParam+"/badges",
		data: {
			client_id: 'MEGIO23IGONXSI22GLYH2MES1WCDDM5LR5L14K0KVU1XQAFD',
			oauth_token: $.cookie('accessToken')
		},
		type: 'GET',
		dataType: 'json',
		success: function(data){
			//updates the loading message to name and picture
			displayBadgesOnMap(normalizeBadgesResponse(data.response));
			//sets the globally saved user object
			userBadges = data.response.user;
		}
	});	
}	

function normalizeBadgesResponse(response)
{
	allBadges=response.badges;
	groups=response.sets.groups;
	earned=groups[0].items;

	/*
	var badges=[];
	
	badges[0] = {
		id:'4d17e79025cda143ddd17ad6',
		name: 'Epic Swarm',
		description: 'Wow! 1,000 foursquare users in the same location?!? According to our math, the world should implode right about now.',
		image: "http://foursquare.com/img/badge/57/epic_swarm.png",
		venues:[{
			count: 1,
			id:'4d1759fd25cda143c24876d6',
			name:'Snowpocalypse 2010',
			lat: 40.75102830623012,
			lng: -73.98862838745117
		}]
	};*/
	
	unlocked={};
	$.each(earned, function(index, value) { 
		unlocked[value]=allBadges[value];
	});

	return unlocked;
}

function displayBadgesOnMap(badges)
{
	
	infoWindow = new google.maps.InfoWindow({
		content:"",
		map:map
	});

	var bounds = new google.maps.LatLngBounds();

	foundVenue = false;
	
	$.each(badges, function(key,badge) {
		checkins_value = badge.unlocks[0].checkins[0];
		//$.each(badge.unlocks, function(unlock_index, unlock_value) {
			//$.each(unlock_value, function(checkins_index, checkins_value) {
			//});
		//}); 
		venue = checkins_value.venue;
		image_url = badge.image.prefix + badge.image.sizes[0] + badge.image.name;
		lat = venue.location.lat;
		lng = venue.location.lng;
		makeMarker(
				venue.location.lat, 
				venue.location.lng, 
				badge.name, 
				image_url,
				buildInfoWindowContent(badge, venue));

		bounds.extend(new google.maps.LatLng(lat, lng));
			
		foundVenue = true;
	});

	if(foundVenue)
	{
		map.fitBounds(bounds);
		map.setCenter(bounds.getCenter());
	}
}

function buildInfoWindowContent(badge, venue)
{
	var content = "<div style='vertical-align:top;'>";
/*	
	if(checkin.venue.categories && checkin.venue.categories.length >0)
	{
		content+= "<div style='float:right; width:45px; height:45px;'><img style='padding:5px;' src='"+checkin.venue.categories[0].icon+"' /></div>";
	}
*/
	content += "<a target='_blank' href='http://foursquare.com/venue/"+venue.id+"'>"+venue.name+"</a>";
	content +="<br />";
/*	
	if(checkin.venue.location && checkin.venue.location.address)
	{
		content +=checkin.venue.location.address;
		content +="<br />";

		if(checkin.venue.location.crossStreet)
		{
			content +="("+checkin.venue.location.crossStreet+")";
			content +="<br />";
		}
	}

	
	if(checkin.shout)
	{
		content += checkin.shout;
		content +="<br />";
	}
*/
	return content;
}

function makeMarker(lat, lng, title, image, content) 
{
	var marker = new google.maps.Marker({
		map: map,
		title:title, 
		icon: image,
		position: new google.maps.LatLng(lat, lng)
	});
	
	/*
	    var marker = new google.maps.Marker({
        position: myLatLng,
        map: map,
        shadow: shadow,
        icon: image,
        shape: shape,
        title: beach[0],
        zIndex: beach[3]
    });

	*/
	
	markers.push(marker);

	google.maps.event.addListener(marker, 'click', function() {
		infoWindow.setPosition(marker.getPosition());
		infoWindow.setContent(content);
		infoWindow.open(map, this);
	});
}

function initializeMap() 
{
	try
	{
	    var latlng = new google.maps.LatLng(40.7409173, -74.02867);
	    var myOptions = {
	      zoom: 12,
	      center: latlng,
	      mapTypeId: google.maps.MapTypeId.ROADMAP
	    }
	
	    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	}
	catch(e){}
}

var lastTweetId = '';

function refreshTweets()
{
	$.ajax({
		url: "http://search.twitter.com/search.json",
		data: {
			q: '@thePoofy OR from:thePoofy include:retweets',
			result_type: 'recent',
			rpp: 20,
			since_id: lastTweetId
		},
		type: 'GET',
		dataType: 'jsonp',
		cache: false,
		jsonpCallback: "renderTweets"
	});
	
	//window.setTimeout(refreshTweets, 30000);
}

function renderTweets(tweets)
{
	lastTweetId = tweets.max_id_str;

	if(tweets.results.length > 0)
	{
		for(var i=tweets.results.length-1; i>=0; i--)
		{
			if($('#tweetList').children().length == 0)
			{
				$('#tweetList').append(buildTweetDiv(tweets.results[i]));
			}
			else
			{
				$('#tweetList div:first').before(buildTweetDiv(tweets.results[i]));
			}
		}
	}

	twttr.anywhere(function(twitter) {
		twitter.hovercards();
	});
}


function buildTweetDiv(tweet)
{
	if(tweet == null)
	{
		return;
	}
	var wrapperDiv = $(document.createElement('div'))
		.addClass('tweet')
		.addClass(function(){
			if(tweet.from_user == "thepoofy")
			{
				return "tweetFrom";
			}
			return "tweetTo";
		});
	
	var fromDiv = $(document.createElement('div'))
				.addClass("user left")
				.append($('<span />')
					.text('@'+tweet.from_user));
	
	var d = new Date(tweet.created_at);
	var dateFormat = d.toLocaleDateString();
	var dateDiv = $(document.createElement('div'))
				.addClass("user right")
				.text(dateFormat);
	
	var contentDiv = $(document.createElement('div'))
				.addClass("content clear")
				.html(tweet.text);
	
	$(wrapperDiv).append(fromDiv);
	$(wrapperDiv).append(dateDiv);
	$(wrapperDiv).append(contentDiv);

	return wrapperDiv;
}

</script>

</head>
<body>

    <!-- RECOMMENDED if your web app will not function without JavaScript enabled -->
    <noscript>
      <div style="width: 22em; position: absolute; left: 50%; margin-left: -11em; color: red; background-color: white; border: 1px solid red; padding: 4px; font-family: sans-serif">
        Your web browser must have JavaScript enabled
        in order for this application to display correctly.
      </div>
    </noscript>
    <div class="header">
		<h1>Badge Assistant</h1>
	    
	    <span id="userInfo">
	    	
	    	
	    </span>
	    
	    <div style="clear:both;"></div>
	</div>
	
	<div id="map_canvas" ></div>
	
<!-- 	
<table class="layout">
	<tr>
		<td style="width:750px;">
			
		</td>
		<td style="width:10px;"> </td>
		<td style="width:240px;">
			<div id="tweetList"></div>
		</td>
   </tr>
</table>
 -->
<div class="layout footer">
	This site developed by <a target="_blank" href="mailto://william.vanderhoef@gmail.com">William Vanderhoef</a> and <a href="mailto://masondu@gmail.com">Mason Du</a> for Foursquare Hack Day 2/19/2011
</div>
</body>
</html>
